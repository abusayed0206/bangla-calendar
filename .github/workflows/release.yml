# Release Workflow - Triggered on version tags
# Creates GitHub Release with binaries and MSIX package for Windows Store
name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on v0.0.1, v1.0.0, etc.

env:
  CARGO_TERM_COLOR: always
  APP_NAME: bangla-calendar

jobs:
  build-release:
    name: Build Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          $msixVersion = "$version.0"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "MSIX_VERSION=$msixVersion" >> $env:GITHUB_OUTPUT
          echo "Building version: $version (MSIX: $msixVersion)"

      - name: Build release binary
        run: cargo build --release

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          New-Item -ItemType Directory -Force -Path "release-artifacts" | Out-Null
          Copy-Item "target/release/${{ env.APP_NAME }}.exe" "release-artifacts/"
          Compress-Archive -Path "release-artifacts/${{ env.APP_NAME }}.exe" `
            -DestinationPath "release-artifacts/${{ env.APP_NAME }}-v$version-windows-x64.zip"

      - name: Build MSIX Package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $msixVersion = "${{ steps.version.outputs.MSIX_VERSION }}"
          
          # Create a clean staging directory
          $stagingDir = "msix-staging"
          New-Item -ItemType Directory -Force -Path $stagingDir | Out-Null
          New-Item -ItemType Directory -Force -Path "$stagingDir/Assets" | Out-Null
          
          # Copy assets
          Copy-Item "msix-package/Assets/*" "$stagingDir/Assets/" -Recurse
          
          # Copy manifest - update version inline using simple file copy and sed-like replacement
          $manifestPath = "$stagingDir/AppxManifest.xml"
          Copy-Item "msix-package/AppxManifest.xml" $manifestPath
          $content = [System.IO.File]::ReadAllText($manifestPath)
          $content = $content -replace 'Version="[\d\.]+"', "Version=`"$msixVersion`""
          [System.IO.File]::WriteAllText($manifestPath, $content)
          
          # Copy binary
          Copy-Item "target/release/${{ env.APP_NAME }}.exe" "$stagingDir/"
          
          # Find Windows SDK tools
          $sdkPath = "C:\Program Files (x86)\Windows Kits\10\bin"
          $sdkVersions = Get-ChildItem $sdkPath -Directory | Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } | Sort-Object { [version]$_.Name } -Descending
          $latestSdk = $sdkVersions | Select-Object -First 1
          
          if (-not $latestSdk) {
            Write-Error "Windows SDK not found"
            exit 1
          }
          
          $makepri = Join-Path $latestSdk.FullName "x64\makepri.exe"
          $makeappx = Join-Path $latestSdk.FullName "x64\makeappx.exe"
          
          Write-Host "Using SDK: $($latestSdk.Name)"
          Write-Host "MakePri: $makepri"
          Write-Host "MakeAppx: $makeappx"
          
          # Generate resources.pri using index name (bypasses manifest parsing)
          Write-Host "`nGenerating resources.pri..."
          & $makepri createconfig /cf "$stagingDir/priconfig.xml" /dq en-US /o
          & $makepri new /pr "$stagingDir" /cf "$stagingDir/priconfig.xml" /in "abusayed.dev.BanglaCalenderforWindows" /of "$stagingDir/resources.pri" /o
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "MakePri failed, trying without resources.pri..."
            # Continue without resources.pri - MakeAppx can still work
          }
          
          # Remove priconfig.xml as it's not needed in the package
          Remove-Item "$stagingDir/priconfig.xml" -ErrorAction SilentlyContinue
          
          # List staging contents
          Write-Host "`nStaging directory contents:"
          Get-ChildItem $stagingDir -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
          
          # Create MSIX package
          Write-Host "`nCreating MSIX package..."
          $msixPath = "release-artifacts/BanglaCalendar_$($msixVersion)_x64.msix"
          & $makeappx pack /d "$stagingDir" /p $msixPath /o
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MakeAppx failed"
            exit 1
          }
          
          Write-Host "MSIX package created: $msixPath"

      - name: Create MSIX upload package
        shell: pwsh
        run: |
          $msixVersion = "${{ steps.version.outputs.MSIX_VERSION }}"
          $msixPath = "release-artifacts/BanglaCalendar_$($msixVersion)_x64.msix"
          $uploadPath = "release-artifacts/BanglaCalendar_$($msixVersion)_x64.msixupload"
          
          $tempDir = Join-Path $env:TEMP "msixupload_temp_$([guid]::NewGuid())"
          New-Item -ItemType Directory -Force -Path $tempDir | Out-Null
          Copy-Item $msixPath $tempDir
          Compress-Archive -Path "$tempDir\*" -DestinationPath $uploadPath -Force
          Remove-Item $tempDir -Recurse -Force
          
          Write-Host "MSIX upload package created: $uploadPath"

      - name: List release artifacts
        shell: pwsh
        run: |
          Get-ChildItem "release-artifacts" | Format-Table Name, Length

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ".github/changelog-config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Bangla Calendar v${{ steps.version.outputs.VERSION }}"
          body: |
            ## Bangla Calendar v${{ steps.version.outputs.VERSION }}
            
            বাংলা ক্যালেন্ডার - A beautiful Bangla date widget for Windows
            
            ### Downloads
            
            | File | Description |
            |------|-------------|
            | `${{ env.APP_NAME }}-v${{ steps.version.outputs.VERSION }}-windows-x64.zip` | Portable Windows executable |
            | `BanglaCalendar_${{ steps.version.outputs.MSIX_VERSION }}_x64.msix` | Windows Store package (for sideloading) |
            | `BanglaCalendar_${{ steps.version.outputs.MSIX_VERSION }}_x64.msixupload` | Windows Store submission package |
            
            ### Installation
            
            **Portable Version:**
            1. Download the `.zip` file
            2. Extract and run `bangla-calendar.exe`
            
            **Windows Store (Coming Soon):**
            - Search "Bangla Calender for Windows" in Microsoft Store
            - Store ID: `9NFWS2MHSH0T`
            
            ### Changes
            
            ${{ steps.changelog.outputs.changelog }}
            
          files: |
            release-artifacts/${{ env.APP_NAME }}-v${{ steps.version.outputs.VERSION }}-windows-x64.zip
            release-artifacts/BanglaCalendar_${{ steps.version.outputs.MSIX_VERSION }}_x64.msix
            release-artifacts/BanglaCalendar_${{ steps.version.outputs.MSIX_VERSION }}_x64.msixupload
          draft: false
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') || contains(github.ref_name, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload MSIX for Store submission
        uses: actions/upload-artifact@v4
        with:
          name: windows-store-package
          path: release-artifacts/*.msixupload
          retention-days: 90
